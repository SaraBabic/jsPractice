<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Add Butterfly</title>
</head>
<body class="bodyForm">
    <form method="post" enctype="multipart/form-data" action="/process.php">
        <label for="latinskoIme">Latinsko ime leptira: </label>
        <input id="latinskoIme" type="text" required="required">

        <!-- prevodi -->
        <div id="translations">
            
        </div>
        <div id="addButton"></div>
        

        <div id="colorFilters"></div>

        <label>Lokacija:</label>
        <input id="geoWidth" placeholder="geografska sirina" type="text">
        <input id="geoLength" placeholder="geografska duzina" type="text">
        <input id="geoHeigth" placeholder="nadmorska visina" type="text">
        <br><br>
        <label for="date">Datum nalaza:</label>
        <input type="date" id="date">
        <br><br>
        <label for="picture">Slike:</label>
        <input type="file" id="picture">

        <div id="errorMessage"></div>
        <button id="addButterfly">Dodaj leptira</button>

    </form>
    <script>
         const colorMapper = [
            {
                ime: "Å¾uta",
                boja: "#d9b650"
            },
            {
                ime: "bela",
                boja: "#ffffff"
            },
            {
                ime: "plava",
                boja: "#0092ca"
            },
            {
                ime: "braon",
                boja: "#77625c"
            },
            {
                ime: "crvena",
                boja: "#BF3131"
            },
            {
                ime: "zelena",
                boja: "#597E52"
            },
         ];

         let languages = [
            "srpski",
            "madjarski",
            "engleski"
         ];

        // Colors.
        let colorPalette = document.getElementById('colorFilters');
        function listColors(colors) {
            colors.forEach(function(color) {
                colorPalette.insertAdjacentHTML('beforeEnd', 
                `<div id="${color.ime}" class="color" style="background-color: ${color.boja}">${color.ime}</div>`
                );
            });
        };
        listColors(colorMapper);

        // Select Colors.
        let colors = document.querySelectorAll(".color");
        colors.forEach(function(color) {
            color.addEventListener('click', function() {
                if(!color.classList.contains('selected')) {
                color.classList.add('selected');
                }
                else {
                    color.classList.remove('selected');
                }
            });
        });


        // Translation.
        let translationsDiv = document.getElementById('translations');

        const addTranslationButton = document.createElement('div');
        addTranslationButton.id = "addTranslationButton";
        addTranslationButton.textContent = "Dodaj prevod";

        const addButtonWrapper = document.getElementById('addButton');

        addButtonWrapper.appendChild(addTranslationButton);

        let wrapperId = 0;
        addTranslationButton.addEventListener('click', function() {
            const wrapper = document.createElement('div');
            wrapper.id = `${wrapperId}`;
            wrapper.className = 'oneLanguage';
            const select = document.createElement('select');
            select.name = 'languages';

            for(let i = 0; i < languages.length; i++) {
                let color = languages[i];
                let option = document.createElement('option');
                option.value = languages[i];
                option.textContent = languages[i];
                select.appendChild(option);
            }
            const input = document.createElement('input');
            input.required = "required";
            input.type = "text";

            const deleteTranslation = document.createElement('div');
            deleteTranslation.id = `delete-${wrapperId}`;
            deleteTranslation.className = "delete"

            const deleteIkonica = document.createElement('img');
            deleteIkonica.src = './slike/remove.png';
            deleteIkonica.alt = 'delete';

            deleteTranslation.appendChild(deleteIkonica);

            translationsDiv.appendChild(wrapper);
            wrapper.appendChild(select);
            wrapper.appendChild(input); 
            wrapper.appendChild(deleteTranslation);


            // Delete translation button if we added all possible languages.

            if(translationsDiv.children.length >= languages.length) {
                addTranslationButton.remove();
            }
            wrapperId++;
            const deleteButtons = document.querySelectorAll('.delete');
            deleteButtons.forEach(function(button) {
                button.addEventListener("click", function() { 
                    const buttonIdNumber = button.id.slice(7);
                    if(buttonIdNumber == wrapper.id) {
                        document.getElementById(wrapper.id).remove();
                        if(translationsDiv.children.length >= languages.length) {
                            addTranslationButton.remove();
                        } else {
                            addButtonWrapper.appendChild(addTranslationButton);
                        }
                    }
                });
            })
            
        });

        document.getElementById('picture').addEventListener('change', function(event) {
            console.log(event.target.files);
        });
        

        // Add Butterfly.
        const addButterfly = document.getElementById('addButterfly');
        addButterfly.addEventListener('click', function(event) {
            event.preventDefault();
            let latinskoIme = document.getElementById("latinskoIme").value;
            let geografskaSirina = document.getElementById("geoWidth").value;
            let geografskaDuzina = document.getElementById("geoLength").value;
            let geografskaVisina = document.getElementById("geoHeigth").value;
            let datum = document.getElementById("date").value;
            let izabraneBoje = document.querySelectorAll(".selected");
            let imenaBoja = [];
            izabraneBoje.forEach(function(boja) {
                imenaBoja.push(boja.id);
            });

            let prevodi = document.querySelectorAll(".oneLanguage");
            
            let uneseniPrevodi = [];
            let listaJezika = [];
            prevodi.forEach(function(prevod) {
                uneseniPrevodi.push({
                    language: prevod.querySelector('select').value,
                    translation: prevod.querySelector('input').value
                });
                listaJezika.push(prevod.querySelector('select').value);
            });
            function findDuplicates(arr) {
                return new Set(arr).size !== arr.length
            }

            if(findDuplicates(listaJezika)) {
                document.getElementById('errorMessage').insertAdjacentHTML('beforeEnd', `<p style='color: red;' id='languageError'>You can't add one language twice.</p>`);
            }
            if(!findDuplicates(listaJezika)) {
                document.getElementById('languageError').remove();
            }

            // Nije dobro , ne sme da bude empty string!!!! trudimo se :)
            // Ako saljem JSON onda mogu da posaljem NULL, a ako saljem drugi content type onda nmg da saljem NULL
            let newButterfly = {
                name: latinskoIme,
                pictures: []
            };

            if(uneseniPrevodi.length > 0) {
                newButterfly.translations = uneseniPrevodi;
            }
            if(imenaBoja.length > 0) {
                newButterfly.colors = imenaBoja;
            }
            if(geografskaSirina || geografskaDuzina || geografskaVisina) {
                newButterfly.location = {
                    width: geografskaSirina,
                    length: geografskaDuzina,
                    height: geografskaVisina
                };
            }
            if (datum) {
                newButterfly.date = datum;
            }

            // console.log(newButterfly);
        });

        

        

    </script>
</body>
</html>